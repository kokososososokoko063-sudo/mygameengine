<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TinyGameLang â€” Ù…Ø­Ø±Ø± + PixiJS (CodeMirror 5)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- CodeMirror 5 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/eclipse.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>

  <!-- PixiJS v6.5.8 (stable) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.8/browser/pixi.min.js"></script>

  <style>
    body { font-family: sans-serif; }
    .cm-wrap { height:320px; border:1px solid #ddd; border-radius:.5rem; overflow:hidden; }
    .CodeMirror { height:320px; }
    pre.console { background:#000; color:#8fff73; padding:10px; height:140px; overflow:auto; border-radius:.5rem; }
    #pixiContainer canvas { width:100% !important; height:320px !important; display:block; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-6">

  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold mb-2">ğŸ® TinyGameLang â€” Ù…Ø­Ø±Ø± + Ø¹Ø±Ø¶ (PixiJS)</h1>
    <p class="text-gray-600 mb-6 text-sm">Ø¥ØµØ¯Ø§Ø± Ø«Ø§Ø¨Øª ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ GitHub Pages â€” CodeMirror 5 + PixiJS v6.5.8.</p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Ù…Ø­Ø±Ø± -->
      <section class="space-y-3">
        <div class="bg-white p-4 rounded-2xl shadow">
          <div class="flex justify-between items-center mb-2">
            <h2 class="font-semibold">Ø§Ù„Ù…Ø­Ø±Ø±</h2>
            <div class="flex gap-2">
              <button id="runBtn" class="bg-green-600 text-white px-3 py-1 rounded">ØªØ´ØºÙŠÙ„</button>
              <button id="stopBtn" class="bg-red-500 text-white px-3 py-1 rounded">Ø¥ÙŠÙ‚Ø§Ù</button>
              <button id="saveBtn" class="bg-blue-600 text-white px-3 py-1 rounded">Ø­ÙØ¸</button>
            </div>
          </div>
          <div class="cm-wrap">
            <textarea id="codeArea"></textarea>
          </div>
        </div>

        <div class="bg-white p-4 rounded-2xl shadow">
          <h3 class="font-semibold mb-2">Ù…Ø®Ø±Ø¬Ø§Øª / Console</h3>
          <pre id="console" class="console">â€”</pre>
        </div>
      </section>

      <!-- Ø§Ù„Ø¹Ø±Ø¶ -->
      <section class="bg-white p-4 rounded-2xl shadow">
        <h2 class="font-semibold mb-2">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (PixiJS)</h2>
        <div id="pixiContainer" class="border rounded overflow-hidden" style="height:320px;"></div>
      </section>
    </div>
  </div>

<script>
  // ========== CodeMirror ==========
  const ta = document.getElementById('codeArea');
  ta.value = localStorage.getItem('tiny.code') || 
`background #222
player at 50 140
color player cyan
rect player 24 24
say "Ù…Ø±Ø­Ø¨Ø§Ù‹!"
loop 120
  move player 2 0
end`;
  const editor = CodeMirror.fromTextArea(ta, { mode:"javascript", lineNumbers:true, theme:"eclipse" });
  function getCode(){return editor.getValue();}

  // ========== Console ==========
  const log = msg => { 
    const c = document.getElementById('console');
    c.textContent += "\\n" + msg;
    c.scrollTop = c.scrollHeight;
  };

  // ========== Pixi ==========
  let app = null;
  let runtime = { running:false, speed:1 };

  function createPixi(w=480,h=320) {
    // ØªÙ†Ø¸ÙŠÙ Ø¢Ù…Ù† Ù„Ø£ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø³Ø§Ø¨Ù‚
    if (app) {
      try { app.ticker.stop(); } catch(e){}
      try { app.stage.removeChildren(); } catch(e){}
      try { if (app.renderer && app.renderer.destroy) app.renderer.destroy(true); } catch(e){}
      try { if (app.view && app.view.parentNode) app.view.parentNode.removeChild(app.view); } catch(e){}
      app = null;
      document.getElementById('pixiContainer').innerHTML = '';
    }

    app = new PIXI.Application({ width:w, height:h, backgroundColor:0x000000, resolution:1 });
    document.getElementById('pixiContainer').appendChild(app.view);
    return app;
  }

  function colorToHex(c){
    if(!c) return 0xffffff;
    if(c.startsWith('#')) return parseInt(c.slice(1),16);
    const map={red:0xff0000,green:0x00ff00,blue:0x0000ff,white:0xffffff,black:0x000000,cyan:0x00ffff,orange:0xffa500,yellow:0xffff00,magenta:0xff00ff,gray:0x808080};
    return map[c.toLowerCase()]||0xffffff;
  }

  function parseTiny(src){
    const lines=src.split(/\\r?\\n/),root=[],stack=[];
    const add=n=>stack.length?stack[stack.length-1].body.push(n):root.push(n);
    for(const raw of lines){
      const line=raw.trim(); if(!line||line.startsWith('//'))continue;
      const say=line.match(/^say\\s+"(.*)"$/i); if(say){add({t:'say',text:say[1]});continue;}
      const p=line.split(/\\s+/),f=p[0].toLowerCase();
      if(f==='loop'){add({t:'loop',n:+p[1]||0,body:[]});stack.push(root[root.length-1]);continue;}
      if(f==='end'){stack.pop();continue;}
      let n=null;
      if(f==='background') n={t:'background',color:p[1]};
      else if(f==='player'&&p[1]==='at') n={t:'player_at',x:+p[2],y:+p[3]};
      else if(f==='color'&&p[1]==='player') n={t:'color_player',color:p[2]};
      else if(f==='rect'&&p[1]==='player') n={t:'rect_player',w:+p[2],h:+p[3]};
      else if(f==='circle'&&p[1]==='player') n={t:'circle_player',r:+p[2]};
      else if(f==='move'&&p[1]==='player') n={t:'move_player',dx:+p[2],dy:+p[3]};
      else n={t:'unknown',raw:line};
      add(n);
    }
    return root;
  }

  function flatten(cmds){const out=[];(function push(arr){for(const n of arr){if(n.t==='loop')for(let i=0;i<n.n;i++)push(n.body);else out.push(n);}})(cmds);return out;}

  function startRuntime(code){
    const ast=parseTiny(code),frames=flatten(ast);
    createPixi();
    const stage=app.stage,player={g:new PIXI.Graphics(),x:0,y:0,w:24,h:24,r:null,color:0xffffff};
    stage.addChild(player.g);
    let bg=0x000000,pc=0;
    const texts=[];
    function drawPlayer(){
      player.g.clear().beginFill(player.color);
      if(player.r) player.g.drawCircle(player.x+player.r,player.y+player.r,player.r);
      else player.g.drawRect(player.x,player.y,player.w,player.h);
      player.g.endFill();
    }
    function apply(n){
      switch(n.t){
        case'background':bg=colorToHex(n.color);app.renderer.backgroundColor=bg;break;
        case'player_at':player.x=n.x;player.y=n.y;break;
        case'color_player':player.color=colorToHex(n.color);break;
        case'rect_player':player.w=n.w;player.h=n.h;player.r=null;break;
        case'circle_player':player.r=n.r;player.w=n.r*2;player.h=n.r*2;break;
        case'move_player':player.x+=n.dx;player.y+=n.dy;break;
        case'say':const t=new PIXI.Text(n.text,{fill:0xffffff,fontSize:14});t.x=player.x;t.y=player.y-30;stage.addChild(t);texts.push({t,ttl:100});break;
      }
    }
    runtime.running=true;
    app.ticker.add(()=>{
      if(!runtime.running)return;
      if(pc<frames.length){apply(frames[pc++]);drawPlayer();}
      for(let i=texts.length-1;i>=0;i--){texts[i].ttl--;texts[i].t.x=player.x;texts[i].t.y=player.y-30;if(texts[i].ttl<=0){stage.removeChild(texts[i].t);texts.splice(i,1);}}
      if(pc>=frames.length){runtime.running=false;log('Ø§Ù†ØªÙ‡Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª');}
    });
    log('ØªØ´ØºÙŠÙ„ ' + frames.length + ' Ø£Ù…Ø±.');
  }

  function stopRuntime(){runtime.running=false;log('ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù.');}

  // ========== Ø£Ø²Ø±Ø§Ø± ==========
  document.getElementById('runBtn').onclick=()=>{stopRuntime();document.getElementById('console').textContent='';startRuntime(getCode());};
  document.getElementById('stopBtn').onclick=()=>stopRuntime();
  document.getElementById('saveBtn').onclick=()=>{localStorage.setItem('tiny.code',getCode());log('ØªÙ… Ø§Ù„Ø­ÙØ¸.');};

  log('Ø¬Ø§Ù‡Ø² â€” Ø¹Ø¯Ù‘Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ø¶ØºØ· ØªØ´ØºÙŠÙ„ ğŸ¯');
</script>
</body>
</html>
